# Kokoro-82M TTS Docker Compose Configuration
# Production deployment for Remrin.ai

version: "3.9"

services:
  # ==========================================================================
  # Kokoro TTS Service
  # ==========================================================================
  kokoro-tts:
    build:
      context: ./kokoro
      dockerfile: Dockerfile
    container_name: remrin-kokoro-tts
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # Server config
      KOKORO_HOST: "0.0.0.0"
      KOKORO_PORT: "8000"
      KOKORO_WORKERS: "1"

      # Redis connection
      KOKORO_REDIS_URL: "redis://redis:6379"

      # Rate limiting
      KOKORO_RATE_LIMIT_REQUESTS: "60"
      KOKORO_RATE_LIMIT_WINDOW: "60"

      # TTS settings
      KOKORO_DEFAULT_VOICE: "af_heart"
      KOKORO_MAX_TEXT_LENGTH: "5000"
      KOKORO_SAMPLE_RATE: "24000"

      # Model settings
      KOKORO_USE_GPU: "false"
      KOKORO_MODEL_CACHE_DIR: "/app/model_cache"
    volumes:
      # Model cache persistence
      - kokoro-model-cache:/app/model_cache
      # Custom voices (optional)
      - ./kokoro/voices:/app/voices:ro
      # Logs
      - ./logs/kokoro:/app/logs
    networks:
      - kokoro-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 8G
        reservations:
          cpus: "2.0"
          memory: 4G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ==========================================================================
  # Kokoro TTS with GPU Support
  # ==========================================================================
  kokoro-tts-gpu:
    build:
      context: ./kokoro
      dockerfile: Dockerfile
    container_name: remrin-kokoro-tts-gpu
    restart: unless-stopped
    profiles:
      - gpu
    ports:
      - "8001:8000"
    environment:
      KOKORO_HOST: "0.0.0.0"
      KOKORO_PORT: "8000"
      KOKORO_WORKERS: "1"
      KOKORO_REDIS_URL: "redis://redis:6379"
      KOKORO_USE_GPU: "true"
      KOKORO_DEFAULT_VOICE: "af_heart"
    volumes:
      - kokoro-model-cache:/app/model_cache
      - ./logs/kokoro-gpu:/app/logs
    networks:
      - kokoro-network
    depends_on:
      redis:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
        limits:
          memory: 16G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ==========================================================================
  # Redis for Queuing & Rate Limiting
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: remrin-kokoro-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - kokoro-network
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # ==========================================================================
  # Nginx Load Balancer (for horizontal scaling)
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: remrin-kokoro-nginx
    restart: unless-stopped
    profiles:
      - production
    ports:
      - "80:80"
    volumes:
      - ./kokoro/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - kokoro-network
    depends_on:
      - kokoro-tts
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M

# =============================================================================
# Networks
# =============================================================================
networks:
  kokoro-network:
    driver: bridge
    name: remrin-kokoro-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  kokoro-model-cache:
    name: remrin-kokoro-model-cache
  redis-data:
    name: remrin-kokoro-redis-data
