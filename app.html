<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remrin.ai | Soul Interface</title>
    <style>
        /* REMRIN "PREMIUM DARK" THEME üåë */
        :root {
            --bg-color: #0f172a;      /* Deep Navy/Black */
            --sidebar-bg: #1e293b;    /* Slightly lighter dark */
            --text-color: #e2e8f0;    /* Soft White */
            --accent-color: #38bdf8;  /* Remrin Blue */
            --accent-gold: #fbbf24;   /* Premium Gold */
            --user-msg-bg: #334155;
            --ai-msg-bg: rgba(30, 41, 59, 0.9);
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; color: var(--text-color); background: var(--bg-color); }
        
        /* SIDEBAR (ROSTER) */
        #sidebar { 
            width: 300px; 
            background: var(--sidebar-bg); 
            border-right: 1px solid #334155; 
            padding: 0; 
            display: flex; 
            flex-direction: column; 
            z-index: 10;
            box-shadow: 4px 0 15px rgba(0,0,0,0.3);
        }

        .brand-header {
            padding: 25px;
            background: linear-gradient(180deg, rgba(15,23,42,1) 0%, rgba(30,41,59,0) 100%);
            text-align: center;
            border-bottom: 1px solid #334155;
        }

        .brand-header h1 {
            margin: 0;
            font-size: 1.8rem;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #roster-list {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .character-card { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            padding: 12px; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: 0.2s; 
            background: rgba(255,255,255,0.03); 
            border: 1px solid transparent;
        }
        
        .character-card:hover { background: rgba(255,255,255,0.08); }
        .character-card.active { border: 1px solid var(--accent-color); background: rgba(56, 189, 248, 0.1); }
        
        .avatar-small { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #475569; }
        .char-info h4 { margin: 0; font-size: 1rem; color: #f1f5f9; }

        /* MAIN CHAT AREA */
        #main-chat { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background-color: var(--bg-color);
            background-size: cover;
            background-position: center;
            position: relative;
        }

        /* The Overlay makes text readable over the background image */
        #chat-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.85); /* Dark tint */
            backdrop-filter: blur(5px);
            z-index: 0;
        }

        /* CONTENT Z-INDEX fix */
        #chat-header, #messages, #input-area { position: relative; z-index: 1; }
        
        /* HEADER */
        #chat-header { 
            padding: 20px 30px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            background: rgba(15, 23, 42, 0.8);
        }
        
        /* MESSAGES */
        #messages { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .message { max-width: 70%; padding: 15px 20px; border-radius: 18px; line-height: 1.6; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .message.user { align-self: flex-end; background: var(--user-msg-bg); color: #fff; border-bottom-right-radius: 4px; }
        .message.ai { align-self: flex-start; background: var(--ai-msg-bg); border-bottom-left-radius: 4px; border: 1px solid #475569; }
        
        /* INPUT AREA */
        #input-area { padding: 25px; background: var(--sidebar-bg); border-top: 1px solid #334155; display: flex; gap: 10px; }
        #user-input { flex: 1; padding: 15px; border-radius: 10px; border: 1px solid #475569; background: #0f172a; color: white; outline: none; font-size: 1rem; }
        #send-btn { background: var(--accent-color); color: #0f172a; border: none; padding: 0 30px; border-radius: 10px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        #send-btn:hover { opacity: 0.9; }

        /* SETTINGS */
        #settings-btn { margin: 20px; padding: 12px; background: rgba(255,255,255,0.05); color: #94a3b8; border: 1px solid #334155; border-radius: 8px; cursor: pointer; }
        #settings-btn:hover { background: rgba(255,255,255,0.1); color: white; }

        /* MODAL */
        #api-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 25px; border-radius: 15px; border: 1px solid #475569; box-shadow: 0 20px 50px rgba(0,0,0,0.5); z-index: 100; width: 320px; color: white; }
        #overlay-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99; }
        
        .speak-btn { position: absolute; bottom: -25px; right: 0; background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.5; filter: grayscale(100%); }
        .speak-btn:hover { opacity: 1; filter: none; transform: scale(1.1); }

    </style>
</head>
<body>

    <div id="sidebar">
        <div class="brand-header">
            <h1>Remrin<span style="color:white">.ai</span></h1>
        </div>
        
        <div id="roster-list">
            </div>
        <button id="settings-btn" onclick="openSettings()">‚öôÔ∏è Connection Settings</button>
    </div>

    <div id="main-chat">
        <div id="chat-overlay"></div> <header id="chat-header">
            <div>
                <h2 id="char-name" style="margin:0; color:white;">Select a Soul</h2>
                <span id="char-tagline" style="color:#94a3b8;">...to begin the connection.</span>
            </div>
        </header>

        <div id="messages">
            <div class="message ai">
                System Online. The Remrin Engine is ready. Please select a companion from the roster. üíô
            </div>
        </div>

        <div id="input-area">
            <input type="text" id="user-input" placeholder="Type your message..." onkeypress="handleEnter(event)">
            <button id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <div id="overlay-modal" onclick="closeSettings()"></div>
    <div id="api-modal">
        <h3 style="margin-top:0">System Keys üóùÔ∏è</h3>
        <label>Gemini API Key:</label>
        <input type="password" id="gemini-key" placeholder="Paste Gemini Key" style="width:100%; padding:10px; margin:10px 0; background:#0f172a; border:1px solid #475569; color:white; border-radius:5px;">
        <label>ElevenLabs API Key:</label>
        <input type="password" id="eleven-key" placeholder="Paste ElevenLabs Key" style="width:100%; padding:10px; margin:10px 0; background:#0f172a; border:1px solid #475569; color:white; border-radius:5px;">
        <button onclick="saveKeys()" style="width:100%; padding:10px; background:var(--accent-color); color:#0f172a; font-weight:bold; border:none; border-radius:5px; cursor:pointer;">Save Credentials</button>
    </div>

    <script>
        // THE ROSTER (Updated with your file paths)
        const characters = [
            { id: 'don', name: 'Don Pooh-leone', file: 'don_pooh_leone.json', img: 'content/assets/heroes/don_pooh_leone_hero.jpg' },
            { id: 'bear_bear', name: 'Bear Bear', file: 'bear_bear.json', img: 'content/assets/heroes/bear_bear_hero.jpg' },
            { id: 'xen', name: 'Master Xen', file: 'xen.json', img: 'content/assets/heroes/master_xen_hero.jpg' },
            { id: 'fenris', name: 'Fenris', file: 'fenris.json', img: 'content/assets/heroes/fenris_hero.jpg' },
            { id: 'rinn', name: 'Rinn', file: 'rinn.json', img: 'content/assets/heroes/rinn_hero_v2.jpg' },
            { id: 'princess_bee', name: 'Princess Bee', file: 'princess_bee.json', img: 'content/assets/heroes/bee_hero1.jpg' },
            { id: 'larz', name: 'Larz', file: 'larz.json', img: 'content/assets/heroes/larz_hero.jpg' },
            { id: 'vorath', name: 'Vorath', file: 'vorath.json', img: 'content/assets/heroes/vorath_hero.jpg' },
            { id: 'niri', name: 'Niri', file: 'niri.json', img: 'content/assets/heroes/niri_hero_v1.jpg' },
            { id: 'atom', name: 'A.T.O.M.', file: 'atom.json', img: 'content/assets/heroes/atom_hero.jpg' },
            { id: 'glytch', name: 'Glytch', file: 'glytch.json', img: 'content/assets/heroes/glytch_hero.jpg' }
        ];

        let currentPersona = null;

        // INIT
        window.onload = () => {
            const list = document.getElementById('roster-list');
            characters.forEach(char => {
                const div = document.createElement('div');
                div.className = 'character-card';
                div.onclick = () => loadCharacter(char);
                div.innerHTML = `
                    <img src="${char.img}" class="avatar-small">
                    <div class="char-info">
                        <h4>${char.name}</h4>
                    </div>
                `;
                list.appendChild(div);
            });
            
            if(localStorage.getItem('gemini_key')) document.getElementById('gemini-key').value = localStorage.getItem('gemini_key');
            if(localStorage.getItem('eleven_key')) document.getElementById('eleven-key').value = localStorage.getItem('eleven_key');
        };

        // LOAD CHARACTER (Now sets Background Wallpaper!)
        async function loadCharacter(char) {
            // Visual Active State
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Text Updates
            document.getElementById('char-name').innerText = char.name;
            document.getElementById('messages').innerHTML = ''; 

            // WALLPAPER ENGINE: Set the chat background to the character image
            const chatArea = document.getElementById('main-chat');
            chatArea.style.backgroundImage = `url('${char.img}')`;

            // Fetch JSON Soul
            try {
                const response = await fetch(`content/characters/${char.file}`);
                const data = await response.json();
                currentPersona = data;
                document.getElementById('char-tagline').innerText = currentPersona.CORE_IDENTITY.Tagline;
                
                // Greeting
                setTimeout(() => {
                   const opening = currentPersona.BEHAVIORAL_DIRECTIVES["1_OPENING_HOOK"] || "Hello!";
                   addMessage('ai', opening); 
                }, 500);
            } catch (e) {
                console.error(e);
                addMessage('ai', 'Error loading Soul file.');
            }
        }

        // CHAT LOGIC
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value;
            if (!text) return;
            
            addMessage('user', text);
            input.value = '';

            const geminiKey = localStorage.getItem('gemini_key');
            if (!geminiKey) {
                addMessage('ai', '‚ö†Ô∏è Please set your Gemini API Key in Settings to chat.');
                return;
            }

            addMessage('ai', '...', true); 

            try {
                const systemPrompt = `You are playing the role of ${currentPersona.CORE_IDENTITY.Name}. 
                TONE: ${currentPersona.TONE_AND_VOICE_RULES.Speech_Pattern} 
                CONTEXT: ${JSON.stringify(currentPersona.CORE_IDENTITY)}`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [
                            { role: "user", parts: [{ text: systemPrompt + "\n\nUser: " + text }] }
                        ]
                    })
                });
                
                const data = await response.json();
                const aiReply = data.candidates[0].content.parts[0].text;
                
                document.querySelector('.loading-msg').remove();
                addMessage('ai', aiReply);

            } catch (e) {
                if(document.querySelector('.loading-msg')) document.querySelector('.loading-msg').remove();
                addMessage('ai', 'Error connecting to Gemini. Check API Key.');
            }
        }

        function addMessage(role, text, isLoading = false) {
            const div = document.createElement('div');
            div.className = `message ${role} ${isLoading ? 'loading-msg' : ''}`;
            div.innerText = text;
            
            if (role === 'ai' && !isLoading) {
                const btn = document.createElement('button');
                btn.className = 'speak-btn';
                btn.innerText = 'üîä';
                btn.onclick = () => speakText(text);
                div.appendChild(btn);
            }
            
            document.getElementById('messages').appendChild(div);
            div.scrollTop = div.scrollHeight;
            div.scrollIntoView({ behavior: 'smooth' });
        }

        // 11LABS LOGIC
        async function speakText(text) {
            const key = localStorage.getItem('eleven_key');
            if (!key) { alert("Please save ElevenLabs Key in settings!"); return; }
            const voiceId = "21m00Tcm4TlvDq8ikWAM"; // Default
            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                    method: 'POST',
                    headers: { 'xi-api-key': key, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_monolingual_v1",
                        voice_settings: { stability: 0.5, similarity_boost: 0.5 }
                    })
                });
                const blob = await response.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
            } catch (e) { alert("Voice Error"); }
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
        function openSettings() { document.getElementById('api-modal').style.display = 'block'; document.getElementById('overlay-modal').style.display = 'block'; }
        function closeSettings() { document.getElementById('api-modal').style.display = 'none'; document.getElementById('overlay-modal').style.display = 'none'; }
        function saveKeys() {
            localStorage.setItem('gemini_key', document.getElementById('gemini-key').value);
            localStorage.setItem('eleven_
