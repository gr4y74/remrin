<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remrin.ai | Beta Interface</title>
    <style>
        /* REMRIN "SOFT GHIBLI" UI THEME */
        :root {
            --bg-color: #FDFBF7;
            --sidebar-bg: #F0EFE9;
            --chat-bg: #FFFFFF;
            --accent-color: #5D8A66; /* Totoro Green */
            --text-color: #2C3E50;
            --user-msg-bg: #E8F6E9;
            --ai-msg-bg: #F9F9F9;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; color: var(--text-color); background: var(--bg-color); }
        
        /* SIDEBAR (ROSTER) */
        #sidebar { width: 280px; background: var(--sidebar-bg); border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .character-card { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 12px; cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.5); }
        .character-card:hover { background: #fff; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .character-card.active { border: 2px solid var(--accent-color); background: #fff; }
        .avatar-small { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; }
        .char-info h4 { margin: 0; font-size: 1rem; }
        .char-info span { font-size: 0.8rem; color: #7f8c8d; }

        /* MAIN CHAT AREA */
        #main-chat { flex: 1; display: flex; flex-direction: column; background: var(--chat-bg); }
        
        /* HEADER */
        #chat-header { padding: 15px 30px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        #current-hero-img { width: 60px; height: 60px; border-radius: 15px; object-fit: cover; border: 2px solid var(--accent-color); }
        
        /* MESSAGES */
        #messages { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .message { max-width: 70%; padding: 15px 20px; border-radius: 18px; line-height: 1.5; position: relative; }
        .message.user { align-self: flex-end; background: var(--user-msg-bg); border-bottom-right-radius: 4px; }
        .message.ai { align-self: flex-start; background: var(--ai-msg-bg); border-bottom-left-radius: 4px; border: 1px solid #eee; }
        
        /* INPUT AREA */
        #input-area { padding: 20px; background: #fff; border-top: 1px solid #eee; display: flex; gap: 10px; }
        #user-input { flex: 1; padding: 15px; border-radius: 25px; border: 1px solid #ddd; outline: none; font-size: 1rem; }
        #send-btn { background: var(--accent-color); color: white; border: none; padding: 0 25px; border-radius: 25px; cursor: pointer; font-weight: bold; }
        
        /* SETTINGS (API KEY) */
        #settings-btn { margin-top: auto; padding: 10px; background: #ddd; border: none; border-radius: 8px; cursor: pointer; }
        #api-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 100; width: 300px; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99; }
        
        .speak-btn { position: absolute; bottom: -25px; right: 0; background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.5; }
        .speak-btn:hover { opacity: 1; transform: scale(1.1); }

    </style>
</head>
<body>

    <div id="sidebar">
        <h3 style="padding-left:10px; color:var(--accent-color);">Remrin Roster</h3>
        <div id="roster-list">
            </div>
        <button id="settings-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
    </div>

    <div id="main-chat">
        <header id="chat-header">
            <img id="current-hero-img" src="" alt="Hero" style="display:none;">
            <div>
                <h2 id="char-name" style="margin:0;">Select a Soul</h2>
                <span id="char-tagline" style="color:#7f8c8d;">...to begin your journey.</span>
            </div>
        </header>

        <div id="messages">
            <div class="message ai">
                Welcome to the Remrin.ai Beta. Select a character from the sidebar to initialize their Soul. üíô
            </div>
        </div>

        <div id="input-area">
            <input type="text" id="user-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
            <button id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <div id="overlay" onclick="closeSettings()"></div>
    <div id="api-modal">
        <h3>System Settings</h3>
        <label>Gemini API Key (For Brain):</label>
        <input type="password" id="gemini-key" placeholder="Paste Gemini Key" style="width:100%; margin-bottom:10px;">
        <label>ElevenLabs API Key (For Voice):</label>
        <input type="password" id="eleven-key" placeholder="Paste ElevenLabs Key" style="width:100%; margin-bottom:10px;">
        <button onclick="saveKeys()" style="width:100%; padding:10px; background:var(--accent-color); color:white; border:none; border-radius:5px; cursor:pointer;">Save Keys</button>
    </div>

    <script>
        // THE ROSTER CONFIGURATION
        const characters = [
            { id: 'bear_bear', name: 'Bear Bear', file: 'bear_bear.json', img: 'content/assets/heroes/bear_bear_hero.png' },
            { id: 'don', name: 'Don Pooh-leone', file: 'don_pooh_leone.json', img: 'content/assets/heroes/don_pooh_leone_hero.png' },
            { id: 'xen', name: 'Master Xen', file: 'xen.json', img: 'content/assets/heroes/xen_hero.png' },
            { id: 'fenris', name: 'Fenris', file: 'fenris.json', img: 'content/assets/heroes/fenris_hero.png' },
            { id: 'rinn', name: 'Rinn', file: 'rinn.json', img: 'content/assets/heroes/rinn_hero.png' },
            { id: 'princess_bee', name: 'Princess Bee', file: 'princess_bee.json', img: 'content/assets/heroes/princess_bee_hero.png' },
            { id: 'larz', name: 'Larz', file: 'larz.json', img: 'content/assets/heroes/larz_hero.png' },
            { id: 'vorath', name: 'Vorath', file: 'vorath.json', img: 'content/assets/heroes/vorath_hero.png' },
            { id: 'niri', name: 'Niri', file: 'niri.json', img: 'content/assets/heroes/niri_hero.png' },
            { id: 'atom', name: 'A.T.O.M.', file: 'atom.json', img: 'content/assets/heroes/atom_hero.png' },
            { id: 'glytch', name: 'Glytch', file: 'glytch.json', img: 'content/assets/heroes/glytch_hero.png' }
        ];

        let currentPersona = null;
        let chatHistory = [];

        // INIT
        window.onload = () => {
            const list = document.getElementById('roster-list');
            characters.forEach(char => {
                const div = document.createElement('div');
                div.className = 'character-card';
                div.onclick = () => loadCharacter(char);
                div.innerHTML = `
                    <img src="${char.img}" class="avatar-small" onerror="this.src='https://via.placeholder.com/50'">
                    <div class="char-info">
                        <h4>${char.name}</h4>
                    </div>
                `;
                list.appendChild(div);
            });
            
            // Load keys if saved
            if(localStorage.getItem('gemini_key')) document.getElementById('gemini-key').value = localStorage.getItem('gemini_key');
            if(localStorage.getItem('eleven_key')) document.getElementById('eleven-key').value = localStorage.getItem('eleven_key');
        };

        // LOAD CHARACTER
        async function loadCharacter(char) {
            // Visual Update
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.getElementById('char-name').innerText = char.name;
            document.getElementById('current-hero-img').src = char.img;
            document.getElementById('current-hero-img').style.display = 'block';
            document.getElementById('messages').innerHTML = ''; // Clear chat

            // Fetch JSON Soul
            try {
                const response = await fetch(`content/characters/${char.file}`);
                const data = await response.json();
                currentPersona = data;
                
                // System Welcome
                addMessage('ai', `System: ${char.name} soul loaded. ${currentPersona.CORE_IDENTITY.Tagline}`);
                
                // Mock First Message from Char
                setTimeout(() => {
                   const opening = currentPersona.BEHAVIORAL_DIRECTIVES["1_OPENING_HOOK"] || "Hello!";
                   addMessage('ai', opening); 
                }, 500);
                
                chatHistory = []; // Reset history context
            } catch (e) {
                console.error(e);
                addMessage('ai', 'Error loading Soul file. Please check file paths.');
            }
        }

        // CHAT LOGIC
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value;
            if (!text) return;
            
            addMessage('user', text);
            input.value = '';

            const geminiKey = localStorage.getItem('gemini_key');
            if (!geminiKey) {
                addMessage('ai', '‚ö†Ô∏è Please set your Gemini API Key in Settings (‚öôÔ∏è) to chat.');
                return;
            }

            addMessage('ai', 'Thinking...', true); // Placeholder

            // CALL GEMINI (Simplified for Demo)
            try {
                const systemPrompt = `You are playing the role of ${currentPersona.CORE_IDENTITY.Name}. 
                TONE: ${currentPersona.TONE_AND_VOICE_RULES.Speech_Pattern} 
                CONTEXT: ${JSON.stringify(currentPersona.CORE_IDENTITY)}`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [
                            { role: "user", parts: [{ text: systemPrompt + "\n\nUser: " + text }] }
                        ]
                    })
                });
                
                const data = await response.json();
                const aiReply = data.candidates[0].content.parts[0].text;
                
                // Remove placeholder and add real message
                document.querySelector('.loading-msg').remove();
                addMessage('ai', aiReply);

            } catch (e) {
                document.querySelector('.loading-msg').remove();
                addMessage('ai', 'Error connecting to Gemini. Check API Key.');
            }
        }

        function addMessage(role, text, isLoading = false) {
            const div = document.createElement('div');
            div.className = `message ${role} ${isLoading ? 'loading-msg' : ''}`;
            div.innerText = text;
            
            // Add Speak Button for AI
            if (role === 'ai' && !isLoading) {
                const btn = document.createElement('button');
                btn.className = 'speak-btn';
                btn.innerText = 'üîä';
                btn.onclick = () => speakText(text);
                div.appendChild(btn);
            }
            
            document.getElementById('messages').appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        // VOICE LOGIC (11Labs)
        async function speakText(text) {
            const key = localStorage.getItem('eleven_key');
            if (!key) { alert("Please save ElevenLabs Key in settings!"); return; }
            
            // Using a default voice ID for demo - eventually, each JSON needs a VoiceID field!
            // For now, using "Rem" (Generic Female) or Hardcoded ID
            const voiceId = "21m00Tcm4TlvDq8ikWAM"; // Default Rachel
            
            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                    method: 'POST',
                    headers: {
                        'xi-api-key': key,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_monolingual_v1",
                        voice_settings: { stability: 0.5, similarity_boost: 0.5 }
                    })
                });
                
                const blob = await response.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
            } catch (e) {
                alert("Voice Error: Check API Key/Credits");
            }
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
        function openSettings() { document.getElementById('api-modal').style.display = 'block'; document.getElementById('overlay').style.display = 'block'; }
        function closeSettings() { document.getElementById('api-modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
        function saveKeys() {
            localStorage.setItem('gemini_key', document.getElementById('gemini-key').value);
            localStorage.setItem('eleven_key', document.getElementById('eleven-key').value);
            closeSettings();
            alert("Keys Saved! üõ°Ô∏è");
        }
    </script>
</body>
</html>
